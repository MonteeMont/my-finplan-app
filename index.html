<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Financial Plan Dashboard</title>
    <link rel="manifest" href="manifest.json">

    <!-- Favicon Links -->
    <link rel="icon" href="icon-192.svg" type="image/svg+xml" sizes="192x192">
    <link rel="icon" href="icon-512.svg" type="image/svg+xml" sizes="512x512">
    <link rel="apple-touch-icon" href="icon-192.svg">
    
    <meta name="theme-color" content="#2d3748">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple transition for tab content */
        .tab-content {
            display: none;
            transition: opacity 0.3s ease;
        }
        .tab-content.active {
            display: block;
            opacity: 1;
        }
        
        /* Custom styles for a spreadsheet-like table */
        .budget-table th, .budget-table td {
            border: 1px solid #4a5568; /* md:border-gray-700 */
            padding: 0.75rem;
            text-align: left;
        }
        .budget-table th {
            background-color: #2d3748; /* md:bg-gray-800 */
            color: #e2e8f0; /* md:text-gray-200 */
            font-weight: 600;
        }
        .budget-table .category-row {
            background-color: #4a5568; /* md:bg-gray-700 */
            color: #ffffff;
            font-weight: bold;
        }
        .budget-table .total-row {
            background-color: #2d3748; /* md:bg-gray-800 */
            color: #e2e8f0; /* md:text-gray-200 */
            font-weight: bold;
        }
        .budget-table .diff-negative {
            color: #f87171; /* red-400 */
        }
        .budget-table .diff-positive {
            color: #4ade80; /* green-400 */
        }
        .budget-table input[type="number"] {
            background-color: #1a202c; /* md:bg-gray-900 */
            color: #e2e8f0; /* md:text-gray-200 */
            border: 1px solid #718096; /* md:border-gray-600 */
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100px;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #718096;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans leading-normal tracking-normal">

    <div class="container mx-auto p-4 max-w-7xl">

        <header class="mb-6">
            <h1 class="text-4xl font-bold text-white">Our Financial Plan Dashboard</h1>
            <p class="text-lg text-gray-400">Track your budget, clear your debts, and build your future.</p>
        </header>

        <div class="bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded-lg relative mb-6" role="alert">
            <strong class="font-bold">Live Mode:</strong>
            <span class="block sm:inline">Your data is now saved to a shared cloud database and will sync in real-time.</span>
        </div>

        <nav class="mb-6">
            <div class="flex flex-wrap border-b border-gray-700">
                <button class="tab-btn active bg-gray-800 text-white py-3 px-6 rounded-t-lg font-semibold" data-tab="dashboard">Dashboard</button>
                <button class="tab-btn py-3 px-6 rounded-t-lg font-semibold text-gray-400 hover:bg-gray-800 hover:text-white" data-tab="budget">Budget Tracker</button>
                <button class="tab-btn py-3 px-6 rounded-t-lg font-semibold text-gray-400 hover:bg-gray-800 hover:text-white" data-tab="savings">Savings & Funds</button>
                <button class="tab-btn py-3 px-6 rounded-t-lg font-semibold text-gray-400 hover:bg-gray-800 hover:text-white" data-tab="debts">Debt Plan</button>
                <button class="tab-btn py-3 px-6 rounded-t-lg font-semibold text-gray-400 hover:bg-gray-800 hover:text-white" data-tab="plan">Plan Overview</button>
            </div>
        </nav>

        <main>
            <div id="dashboard" class="tab-content active">
                <h2 class="text-3xl font-semibold mb-4 text-white">Dashboard</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Total Savings</h3>
                        <p id="db-total-savings" class="text-4xl font-bold text-white mt-2">£0.00</p>
                        <span id="db-total-savings-diff" class="text-lg font-semibold text-gray-500 mt-1 block"></span>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Emergency Fund</h3>
                        <p id="db-emergency-fund" class="text-4xl font-bold text-white mt-2">£0.00</p>
                        <span id="db-emergency-fund-diff" class="text-lg font-semibold text-gray-500 mt-1 block"></span>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Immigration Fund</h3>
                        <p id="db-immigration-fund" class="text-4xl font-bold text-green-400 mt-2">£0.00</p>
                        <span id="db-immigration-fund-diff" class="text-lg font-semibold text-gray-500 mt-1 block"></span>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Home Deposit Fund</h3>
                        <p id="db-home-deposit" class="text-4xl font-bold text-blue-400 mt-2">£0.00</p>
                        <span id="db-home-deposit-diff" class="text-lg font-semibold text-gray-500 mt-1 block"></span>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-2xl font-semibold mb-4 text-white">This Month's Snapshot (<span id="db-current-month"></span>)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <h4 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Projected Surplus</h4>
                            <p id="db-projected-surplus" class="text-3xl font-bold text-white mt-2">£0.00</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Actual Surplus</h4>
                            <p id="db-actual-surplus" class="text-3xl font-bold text-white mt-2">£0.00</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Net Result</h4>
                            <p id="db-net-result" class="text-3xl font-bold text-white mt-2">£0.00</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="budget" class="tab-content">
                <h2 class="text-3xl font-semibold mb-4 text-white">Budget Tracker</h2>
                
                <div class="mb-6">
                    <label for="month-selector" class="block text-lg font-medium text-gray-300 mb-2">Select Month to View/Edit:</label>
                    <select id="month-selector" class="bg-gray-800 border border-gray-700 text-white text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-1/2 p-3">
                        </select>
                </div>

                <div class="overflow-x-auto bg-gray-800 rounded-xl shadow-lg">
                    <table id="budget-table-render" class="w-full budget-table">
                        </table>
                </div>
            </div>

            <div id="savings" class="tab-content">
                <h2 class="text-3xl font-semibold mb-4 text-white">Savings & Funds Projection</h2>
                <p class="text-gray-400 mb-6">This table projects the growth of your funds over time. It uses your "Actual" data where available and "Projected" data for the future.</p>
                
                <div class="overflow-x-auto bg-gray-800 rounded-xl shadow-lg">
                    <table class="w-full budget-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Emergency Fund</th>
                                <th>Immigration Fund</th>
                                <th>LISA (Montee)</th>
                                <th>LISA (Megan)</th>
                                <th>Joint Home Saver</th>
                                <th>Total Savings</th>
                            </tr>
                        </thead>
                        <tbody id="savings-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="debts" class="tab-content">
                <h2 class="text-3xl font-semibold mb-4 text-white">Debt Plan</h2>
                <p class="text-gray-400 mb-6">This shows your debt clearance plan for March 1st, 2026.</p>
                
                <div class="overflow-x-auto bg-gray-800 rounded-xl shadow-lg">
                    <table class="w-full budget-table">
                        <thead>
                            <tr>
                                <th>Debt</th>
                                <th>Amount to Clear</th>
                                <th>Interest Rate</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="debt-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="plan" class="tab-content">
                <h2 class="text-3xl font-semibold mb-6 text-white">Your Financial Plan: Phase by Phase</h2>
                
                <div class="space-y-8">
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold text-blue-300 mb-4">Phase 1: The "Pre-Phase"</h3>
                        <p class="text-lg font-medium text-gray-400 mb-4">(December 2025 – February 2026)</p>
                        <p class="mb-4">This is your 3-month plan to navigate the immediate future and maximize savings before your debt clearance.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-300 uppercase tracking-wider">Monthly Income</h4>
                                <p class="text-2xl font-bold text-white mt-1">£2,372.22</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-300 uppercase tracking-wider">Monthly Outgoings</h4>
                                <p class="text-2xl font-bold text-white mt-1">-£2,183.07</p>
                            </div>
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-300 uppercase tracking-wider">Projected Surplus</h4>
                                <p class="text-2xl font-bold text-green-400 mt-1">+£189.15</p>
                            </div>
                        </div>

                        <h4 class="text-xl font-semibold mb-2">Actions:</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-300 mb-4">
                            <li><strong>Immediately:</strong> Pay the one-time £161.29 mail-order debt (from Dec surplus).</li>
                            <li><strong>Dec '25 - Feb '26:</strong> Continue to pay all debts as normal.</li>
                            <li><strong>Save the Surplus:</strong> Save all remaining surplus cash. Total saved: £406.16.</li>
                        </ul>
                        
                        <h4 class="text-xl font-semibold mb-2">Outcome (by March 1st, 2026):</h4>
                        <p class="text-gray-300">Your starting savings of £0.00 will grow to <strong>£406.16</strong> from saving your surplus.</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold text-blue-300 mb-4">Phase 2: The "Total Clearance"</h3>
                        <p class="text-lg font-medium text-gray-400 mb-4">(March 1st, 2026)</p>
                        <p class="mb-4">This is the one-time event where you use your savings to gain financial freedom.</p>
                        
                        <h4 class="text-xl font-semibold mb-2">Action:</h4>
                        <p class="text-gray-300 mb-2">On this day, your <strong>£23,497.98</strong> from the house sale becomes available. You will then make one-time payments to clear the following debts in full:</p>
                        <ul class="list-disc list-inside space-y-1 text-gray-300 mb-4 columns-1 md:columns-2">
                            <li>Car Finance: £7,606.44</li>
                            <li>Vodafone: £2,266.50</li>
                            <li>Zable: £800.00</li>
                            <li>118 118: £400.00</li>
                            <li>Airbnb: £420.00</li>
                            <li>AmAir Tickets: £700.00</li>
                        </ul>
                        <div class="bg-red-900 border border-red-700 text-red-200 p-4 rounded-lg mb-4">
                            <h4 class="text-sm font-medium uppercase tracking-wider">Total Cost from Savings</h4>
                            <p class="text-2xl font-bold text-white mt-1">£12,192.94</p>
                        </div>
                        
                        <h4 class="text-xl font-semibold mb-2">Outcome:</h4>
                        <p class="text-gray-300">Your total available savings (<strong>£406.16</strong> from Phase 1 + <strong>£23,497.98</strong> house sale = <strong>£23,904.14</strong>) are used to pay the <strong>£12,192.94</strong> in debts. This leaves your new <strong>Emergency Fund at £11,711.20</strong>.</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold text-blue-300 mb-4">Phase 3: The "Immigration Fund"</h3>
                        <p class="text-lg font-medium text-gray-400 mb-4">(March 2026 – December 2026)</p>
                        <p class="mb-4">Your new long-term personal budget. The £435 additional income is gone, and rent is now £800.</p>
                        
                        <h4 class="text-xl font-semibold mb-2">New Long-Term Monthly Budget:</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-300 mb-4">
                            <li><strong>Monthly Outgoings:</strong> £1,795.57 (All non-debt bills + £50 StepChange + £55 Water)</li>
                            <li><strong>Surplus (March 2026):</strong> £141.65 (On old salary)</li>
                            <li><strong>Surplus (Apr '26 - Dec '26):</strong> £186.21/month (After 2.3% pay rise)</li>
                        </ul>

                        <h4 class="text-xl font-semibold mb-2">Actions:</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-300 mb-4">
                            <li><strong>March 2026:</strong> Open a new "Immigration Fund" savings account.</li>
                            <li><strong>Mar - Dec 2026:</strong> Transfer full surplus to this fund each month. (Total saved: £1,817.54)</li>
                            <li><strong>January 2027:</strong> Pay ~£8,200 immigration costs by using the £1,817.54 from this fund and transferring the remaining ~£6,382.46 from your Emergency Fund.</li>
                        </ul>
                        
                        <h4 class="text-xl font-semibold mb-2">Outcome:</h4>
                        <p class="text-gray-300">Your final <strong>Emergency Fund will be £5,328.74</strong>, which remains a strong safety net.</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold text-blue-300 mb-4">Phase 4: The "Home Purchase" Plan</h3>
                        <p class="text-lg font-medium text-gray-400 mb-4">(From Early 2027)</p>
                        <p class="mb-4">This is your long-term wealth-building plan as a dual-income household.</p>
                        
                        <h4 class="text-xl font-semibold mb-2">Estimated Household Position:</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-300 mb-4">
                            <li><strong>Total Income:</strong> ~£4,081.78 / month (Montee's £1,981.78 + Megan's £2,100.00)</li>
                            <li><strong>Total Surplus:</strong> ~£1,374.56 / month (After all joint bills)</li>
                        </ul>

                        <h4 class="text-xl font-semibold mb-2">Savings Strategy:</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-300 mb-4">
                            <li><strong>Open LISAs:</strong> You and Megan each open a Lifetime ISA (LISA).</li>
                            <li><strong>Max the LISAs:</strong> Save a combined £666.66/month (£333.33 each) to get the 25% government bonus (£10,000/year total).</li>
                            <li><strong>Save the Rest:</strong> Transfer the remaining ~£707.90/month surplus into a joint "House Deposit" account (an extra ~£8,494.80/year).</li>
                        </ul>
                        
                        <h4 class="text-xl font-semibold mb-2">Outcome:</h4>
                        <p class="text-gray-300">You will be on track to save <strong>~£18,494.80 per year</strong>, which will increase automatically with each April pay rise.</p>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <script type="module">
        // Firebase Services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- STATE MANAGEMENT ---
        let state = {
            // Master list of all actuals, will be populated from Firestore
            actuals: {}, 
            // Current month being viewed
            currentMonthView: '', 
            // Base figures
            baseSalary: 1937.22,
            salaryIncreaseRate: 0.023,
            baseSavings: 0.00, // <-- CHANGED: Start at 0
            houseSaleFunds: 23497.98, // <-- ADDED: House sale funds
            // Plan constants
            plan: {
                totalClearanceCost: 12192.94,
                immigrationGoal: 8200.00,
                partnerIncome: 2100.00,
                lisaContribution: 333.33
            }
        };

        // --- FIREBASE GLOBALS ---
        let db;
        let auth;
        let userId;
        let dbCollectionPath; // Will be set after auth
        let budgetCollectionRef; // Firestore collection reference

        // --- CONSTANTS & HELPERS ---
        const MONTHS = [
            '2025-12', '2026-01', '2026-02', '2026-03', '2026-04', '2026-05', '2026-06', 
            '2026-07', '2026-08', '2026-09', '2026-10', '2026-11', '2026-12', '2027-01', '2027-02',
            '2027-03', '2027-04', '2027-05', '2027-06', '2027-07', '2027-08', '2027-09', '2027-10',
            '2027-11', '2027-12', '2028-01', '2028-02', '2028-03', '2028-04', '2028-05', '2028-06',
            '2028-07', '2028-08', '2028-09', '2028-10', '2028-11', '2028-12', '2029-01', '2029-02',
            '2029-03', '2029-04', '2029-05', '2029-06', '2029-07', '2029-08', '2029-09', '2029-10',
            '2029-11', '2029-12', '2030-01', '2030-02', '2030-03', '2030-04', '2030-05', '2030-06',
            '2030-07', '2030-08', '2030-09', '2030-10', '2030-11', '2030-12'
        ];

        const DEBT_SCHEDULE = [
            { id: 'car', name: 'Car Finance', amount: 212.00, clearance: 7606.44, rate: '26.50%' },
            { id: 'voda', name: 'Vodafone', amount: 84.50, clearance: 2266.50, rate: '0%' },
            { id: 'zable', name: 'Zable', amount: 40.00, clearance: 800.00, rate: '20.9%' },
            { id: 'o118', name: '118 118', amount: 35.00, clearance: 400.00, rate: '40.9%' },
            { id: 'debt1', name: 'Airbnb - Jan 26', amount: 70.00, clearance: 420.00, rate: 'N/A' },
            { id: 'debt2', name: 'AmAir - Jan 26', amount: 50.00, clearance: 700.00, rate: 'N/A' },
            { id: 'stepchange', name: 'StepChange DMP', amount: 50.00, clearance: 0, rate: '0%' }
        ];
        
        const f = (num) => num.toLocaleString('en-GB', { style: 'currency', currency: 'GBP' });
        const fNum = (num) => (num || 0).toFixed(2);
        
        const getMonthName = (monthString) => {
            const [year, month] = monthString.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleString('en-GB', { month: 'long', year: 'numeric' });
        };

        /**
         * Renders a +/- change indicator into a span element.
         */
        const renderDiff = (el, value) => {
            if (!el) return;
            if (value > 0.005) { // Use tolerance for float
                el.textContent = `+${f(value)}`;
                el.className = 'text-lg font-semibold text-green-400';
            } else if (value < -0.005) {
                el.textContent = f(value);
                el.className = 'text-lg font-semibold text-red-400';
            } else {
                el.textContent = f(0);
                el.className = 'text-lg font-semibold text-gray-500';
            }
        };

        const getCurrentMonthString = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            return `${year}-${month}`;
        };

        // --- CORE LOGIC (Unchanged) ---

        /**
         * Calculates the user's salary for a given month, including annual 2.3% raises every April.
         */
        function getSalaryForMonth(monthString) {
            const [year, month] = monthString.split('-').map(Number);
            const baseYear = 2026; // First raise is April 2026
            
            if (year < baseYear || (year === baseYear && month < 4)) {
                // Before first raise
                return state.baseSalary; 
            }
            
            // Calculate number of raises
            let raises = year - baseYear;
            if (month < 4) {
                raises--; // Hasn't had this year's raise yet
            }

            let salary = state.baseSalary;
            // Apply raise for 2026
            salary *= (1 + state.salaryIncreaseRate);
            // Apply raises for 2027 onwards
            if (raises > 0) {
                 salary *= Math.pow((1 + state.salaryIncreaseRate), raises);
            }
           
            return salary;
        }

        /**
         * Generates the projected budget for any given month based on the user's multi-phase plan.
         */
        function getProjectedBudget(monthString) {
            const [year, month] = monthString.split('-').map(Number);
            let budget = {
                income: [
                    { id: 'salary', name: "Montee's Salary", amount: 0 },
                    { id: 'addIncome', name: 'Additional Income', amount: 0.00 } // <-- ADDED HERE
                ],
                fixed: [
                    { id: 'rent', name: 'Rent', amount: 0 },
                    { id: 'utilities', name: 'Utilities', amount: 0 },
                    { id: 'water', name: 'Water', amount: 55.00 },
                    { id: 'council', name: 'Council Tax', amount: 130.00 },
                    { id: 'carIns', name: 'Car Insurance', amount: 128.98 },
                    { id: 'phoneNet', name: 'Phone & Internet', amount: 40.00 },
                    { id: 'phoneSvc', name: 'Phone Service', amount: 30.00 },
                    { id: 'houseIns', name: 'House Insurance', amount: 24.00 },
                ],
                variable: [
                    { id: 'groceries', name: 'Groceries', amount: 200.00 },
                    { id: 'transport', name: 'Transport', amount: 80.00 },
                    { id: 'household', name: 'Household Supplies', amount: 20.00 },
                    { id: 'personal', name: 'Personal Care', amount: 20.00 },
                ],
                discretionary: [
                    { id: 'social', name: 'Entertainment & Socialising', amount: 30.00 },
                    { id: 'shopping', name: 'Shopping', amount: 10.00 },
                    { id: 'takeaway', name: 'Eating Out & Takeaways', amount: 10.00 },
                    { id: 'patreon', name: 'Patreon', amount: 9.60 },
                    { id: 'youtube', name: 'Youtube Premium', amount: 7.99 },
                ],
                debts: [],
                savings: []
            };

            // --- Phase 1: "Pre-Phase" (Dec '25 - Feb '26) ---
            if (monthString === '2025-12' || monthString === '2026-01' || monthString === '2026-02') {
                budget.income[0].amount = state.baseSalary;
                // Find the item and set its amount, instead of pushing
                const addIncomeItem = budget.income.find(item => item.id === 'addIncome');
                if (addIncomeItem) addIncomeItem.amount = 435.00;
                
                budget.fixed[0].amount = 695.00; // Rent
                budget.fixed[1].amount = 150.00; // Utilities
                budget.debts = DEBT_SCHEDULE.map(d => ({ id: d.id, name: d.name, amount: d.amount }));
                if (monthString === '2025-12') {
                     budget.discretionary.push({ id: 'mailOrder', name: 'Mail Order Debt', amount: 161.29 });
                }
            }
            // --- Phase 3: "Immigration Fund" (Mar '26 - Dec '26) ---
            else if (year === 2026 && month >= 3) {
                budget.income[0].amount = getSalaryForMonth(monthString); // Handles Apr '26 raise
                budget.fixed[0].amount = 800.00; // New rent
                budget.fixed[1].amount = 150.00; // Utilities
                budget.debts = [{ id: 'stepchange', name: 'StepChange DMP', amount: 50.00 }];
            }
            // --- Phase 4: "Home Purchase" (Jan '27 onwards) ---
            else if (year >= 2027) {
                budget.income[0].amount = getSalaryForMonth(monthString); // Handles raises
                budget.income.push({ id: 'partnerIncome', name: "Megan's Income", amount: state.plan.partnerIncome });
                budget.fixed[0].amount = 800.00; // Rent (assume same, user can change actual)
                budget.fixed[1].amount = 150.00; // Utilities
                budget.debts = [{ id: 'stepchange', name: 'StepChange DMP', amount: 50.00 }];
                
                // Add LISA savings as "expenses"
                budget.savings = [
                    { id: 'lisaSelf', name: 'LISA (Montee)', amount: state.plan.lisaContribution },
                    { id: 'lisaPartner', name: 'LISA (Megan)', amount: state.plan.lisaContribution },
                ];
            }
            
            // Calculate totals
            const sum = (arr) => arr.reduce((acc, item) => acc + item.amount, 0);
            budget.totalIncome = sum(budget.income);
            budget.totalFixed = sum(budget.fixed);
            budget.totalVariable = sum(budget.variable);
            budget.totalDiscretionary = sum(budget.discretionary);
            budget.totalDebts = sum(budget.debts);
            // budget.totalSavings = sum(budget.savings); // This will be handled separately
            
            budget.totalOutgoings = budget.totalFixed + budget.totalVariable + budget.totalDiscretionary + budget.totalDebts;
            budget.projectedSurplus = budget.totalIncome - budget.totalOutgoings;

            // --- Define Planned Savings Transfers based on Surplus ---
            // --- Phase 1: "Pre-Phase" (Dec '25 - Feb '26) ---
            if (monthString === '2025-12' || monthString === '2026-01' || monthString === '2026-02') {
                budget.savings = [{ id: 'emergencyFund', name: 'To Emergency Fund', amount: budget.projectedSurplus }];
            }
            // --- Phase 3: "Immigration Fund" (Mar '26 - Dec '26) ---
            else if (year === 2026 && month >= 3) {
                budget.savings = [{ id: 'immigrationFund', name: 'To Immigration Fund', amount: budget.projectedSurplus }];
            }
            // --- Phase 4: "Home Purchase" (Jan '27 onwards) ---
            else if (year >= 2027) {
                // LISA contributions are already in budget.savings
                const remainingSurplus = budget.projectedSurplus - (state.plan.lisaContribution * 2);
                budget.savings.push({ id: 'jointSaver', name: 'To Joint Home Saver', amount: remainingSurplus });
            }

            return budget;
        }

        /**
         * Calculates the actual surplus for a given month from user-entered data.
         */
        function getActualsForMonth(monthString) {
            const actual = state.actuals[monthString] || {};
            const projected = getProjectedBudget(monthString); // Get structure
            
            let totalIncome = 0;
            projected.income.forEach(item => {
                const actualValue = parseFloat(actual[item.id] !== undefined ? actual[item.id] : 0);
                totalIncome += actualValue;
            });
            
            let totalOutgoings = 0;
            const spendingCategories = ['fixed', 'variable', 'discretionary', 'debts'];
            spendingCategories.forEach(cat => {
                projected[cat].forEach(item => {
                    const actualValue = parseFloat(actual[item.id] !== undefined ? actual[item.id] : 0);
                    totalOutgoings += actualValue;
                });
            });

            let totalSavings = 0;
            projected.savings.forEach(item => {
                 const actualValue = parseFloat(actual[item.id] !== undefined ? actual[item.id] : 0);
                 totalSavings += actualValue;
            });

            return {
                totalIncome,
                totalOutgoings, // Spending
                totalSavings,   // Savings transfers
                actualSurplus: totalIncome - totalOutgoings - totalSavings // Unallocated
            };
        }
        
        // --- RENDERING (Unchanged) ---

        /**
         * Calculates the fund balances up to the end of a specific month.
         * This is a non-rendering pure calculation function.
         */
        function getFundBalancesForMonth(monthString) {
            const baseFunds = {
                emergency: state.baseSavings,
                immigration: 0,
                lisaSelf: 0,
                lisaPartner: 0,
                jointSaver: 0
            };

            // If no month is provided (e.g., before the plan starts), return base funds.
            if (!monthString) {
                return baseFunds;
            }

            let funds = { ...baseFunds };
            const targetIndex = MONTHS.indexOf(monthString);

            // If month isn't in our plan, just return base
            if (targetIndex === -1) {
                return baseFunds;
            }

            // Loop from the start of the plan up to the target month
            for (let i = 0; i <= targetIndex; i++) {
                const month = MONTHS[i];
                const projected = getProjectedBudget(month);
                const actualsMonth = state.actuals[month];
                const actuals = getActualsForMonth(month); // Get actuals regardless
                
                let unallocatedSurplus;
                let emergencyTransfer = 0;
                let immigrationTransfer = 0;
                let lisaSelfTransfer = 0;
                let lisaPartnerTransfer = 0;
                let jointSaverTransfer = 0;

                // Use actual values if they exist, otherwise use projected values
                if (actualsMonth) {
                    unallocatedSurplus = actuals.actualSurplus;
                    emergencyTransfer = parseFloat(actualsMonth['emergencyFund']) || 0;
                    immigrationTransfer = parseFloat(actualsMonth['immigrationFund']) || 0;
                    lisaSelfTransfer = parseFloat(actualsMonth['lisaSelf']) || 0;
                    lisaPartnerTransfer = parseFloat(actualsMonth['lisaPartner']) || 0;
                    jointSaverTransfer = parseFloat(actualsMonth['jointSaver']) || 0;
                } else {
                    // Use projected logic
                    unallocatedSurplus = 0; // Projected unallocated is 0
                    emergencyTransfer = (projected.savings.find(s => s.id === 'emergencyFund') || {}).amount || 0;
                    immigrationTransfer = (projected.savings.find(s => s.id === 'immigrationFund') || {}).amount || 0;
                    lisaSelfTransfer = (projected.savings.find(s => s.id === 'lisaSelf') || {}).amount || 0;
                    lisaPartnerTransfer = (projected.savings.find(s => s.id === 'lisaPartner') || {}).amount || 0;
                    jointSaverTransfer = (projected.savings.find(s => s.id === 'jointSaver') || {}).amount || 0;
                }
                
                funds.emergency += (unallocatedSurplus + emergencyTransfer);
                funds.immigration += immigrationTransfer;
                funds.lisaSelf += lisaSelfTransfer;
                funds.lisaPartner += lisaPartnerTransfer;
                funds.jointSaver += jointSaverTransfer;

                // Handle special events (Clearance, Immigration Payment)
                if (month === '2026-03') {
                    funds.emergency += state.houseSaleFunds; // <-- ADDED: House sale funds arrive
                    funds.emergency -= state.plan.totalClearanceCost; // <-- Existing: Debts are paid
                }
                if (month === '2027-01') {
                    // 1. Pay for immigration
                    const shortfall = state.plan.immigrationGoal - funds.immigration;
                    if (shortfall > 0) {
                        funds.emergency -= shortfall;
                    }
                    funds.immigration = 0; // Fund is spent
                    
                    // 2. Add this month's surplus to the new joint saver
                    // The LISA transfers are already "spent" in the surplus calculation
                    // This logic is now handled above
                }
            }
            
            return funds;
        }

        /**
         * Renders the main budget tracking table for the selected month.
         */
        function renderBudgetTable() {
            const month = state.currentMonthView;
            const budget = getProjectedBudget(month);
            const actuals = state.actuals[month] || {};
            
            let html = `
                <thead>
                    <tr>
                        <th class="w-1/3">Category</th>
                        <th class="w-1/3">Item</th>
                        <th>Projected</th>
                        <th>Actual</th>
                        <th>Difference</th>
                    </tr>
                </thead>
                <tbody>
            `;

            const renderCategory = (name, items) => {
                if (items.length === 0) return;
                
                html += `<tr class="category-row"><td colspan="5">${name}</td></tr>`;
                
                let catProjected = 0;
                let catActual = 0;
                
                items.forEach(item => {
                    // Use actual if set, otherwise default to 0
                    const actualValue = fNum(actuals[item.id] !== undefined ? actuals[item.id] : 0);
                    const diff = fNum(parseFloat(actualValue) - item.amount);
                    catProjected += item.amount;
                    catActual += parseFloat(actualValue);
                    
                    html += `
                        <tr>
                            <td>${(items.indexOf(item) === 0) ? name : ''}</td>
                            <td>${item.name}</td>
                            <td>${f(item.amount)}</td>
                            <td>
                                <input type="number" 
                                       class="actual-input" 
                                       data-month="${month}" 
                                       data-id="${item.id}" 
                                       value="${actualValue}" 
                                       onchange="handleActualChange(event)">
                            </td>
                            <td class="${parseFloat(diff) < 0 ? 'diff-negative' : 'diff-positive'}">${f(parseFloat(diff))}</td>
                        </tr>
                    `;
                });
                
                // Category total
                const catDiff = fNum(catActual - catProjected);
                html += `
                    <tr class="total-row">
                        <td colspan="2" class="text-right font-bold">Total ${name}</td>
                        <td>${f(catProjected)}</td>
                        <td>${f(catActual)}</td>
                        <td class="${catDiff < 0 ? 'diff-negative' : 'diff-positive'}">${f(catDiff)}</td>
                    </tr>
                `;
            };

            renderCategory('Income', budget.income);
            renderCategory('Fixed Expenses', budget.fixed);
            renderCategory('Variable Expenses', budget.variable);
            renderCategory('Discretionary Expenses', budget.discretionary);
            renderCategory('Debts', budget.debts);
            renderCategory('Savings Transfers', budget.savings);

            // --- Grand Totals ---
            const actualsTotals = getActualsForMonth(month);
            const projectedSpending = budget.totalFixed + budget.totalVariable + budget.totalDiscretionary + budget.totalDebts;
            const projectedSavings = (budget.savings || []).reduce((acc, item) => acc + item.amount, 0);
            
            html += `
                <tr class="category-row bg-blue-800 text-white">
                    <td colspan="2" class="text-right font-bold">TOTAL OUTGOINGS (Spending)</td>
                    <td>${f(projectedSpending)}</td>
                    <td>${f(actualsTotals.totalOutgoings)}</td>
                    <td></td>
                </tr>
                <tr class="category-row bg-cyan-800 text-white">
                    <td colspan="2" class="text-right font-bold">TOTAL SAVINGS TRANSFERS</td>
                    <td>${f(projectedSavings)}</td>
                    <td>${f(actualsTotals.totalSavings)}</td>
                    <td></td>
                </tr>
                <tr class="category-row bg-green-800 text-white">
                    <td colspan="2" class="text-right font-bold">NET UNALLOCATED</td>
                    <td>${f(0)}</td> <td>${f(actualsTotals.actualSurplus)}</td>
                    <td class="${actualsTotals.actualSurplus < 0 ? 'diff-negative' : 'diff-positive'}">${f(actualsTotals.actualSurplus)}</td>
                </tr>
            `;

            html += '</tbody>';
            document.getElementById('budget-table-render').innerHTML = html;
        }

        /**
         * Renders the savings projection table, mixing actuals with projections.
         */
        function renderSavingsTable() {
            let html = '';
            let funds = {
                emergency: state.baseSavings,
                immigration: 0,
                lisaSelf: 0,
                lisaPartner: 0,
                jointSaver: 0
            };
            
            let previousFunds = {...funds, total: state.baseSavings};

            // These will be used to populate the dashboard
            let lastFunds = {...funds};
            let currentFunds = null; // To store funds for the current real month
            const currentMonth = getCurrentMonthString();

            const fDiff = (num) => {
                if (num > 0.005) return `<span class="diff-positive">+${f(num)}</span>`; // Use 0.005 for float precision
                if (num < -0.005) return `<span class="diff-negative">${f(num)}</span>`;
                return `<span class="text-gray-500">${f(0)}</span>`;
            };

            for (const month of MONTHS) {
                const projected = getProjectedBudget(month);
                const actualsMonth = state.actuals[month];
                const actuals = getActualsForMonth(month); // Get actuals regardless
                
                let unallocatedSurplus;
                let emergencyTransfer = 0;
                let immigrationTransfer = 0;
                let lisaSelfTransfer = 0;
                let lisaPartnerTransfer = 0;
                let jointSaverTransfer = 0;

                // Use actual values if they exist, otherwise use projected values
                if (actualsMonth) {
                    unallocatedSurplus = actuals.actualSurplus;
                    emergencyTransfer = parseFloat(actualsMonth['emergencyFund']) || 0;
                    immigrationTransfer = parseFloat(actualsMonth['immigrationFund']) || 0;
                    lisaSelfTransfer = parseFloat(actualsMonth['lisaSelf']) || 0;
                    lisaPartnerTransfer = parseFloat(actualsMonth['lisaPartner']) || 0;
                    jointSaverTransfer = parseFloat(actualsMonth['jointSaver']) || 0;
                } else {
                    // Use projected logic
                    unallocatedSurplus = 0; // Projected unallocated is 0
                    emergencyTransfer = (projected.savings.find(s => s.id === 'emergencyFund') || {}).amount || 0;
                    immigrationTransfer = (projected.savings.find(s => s.id === 'immigrationFund') || {}).amount || 0;
                    lisaSelfTransfer = (projected.savings.find(s => s.id === 'lisaSelf') || {}).amount || 0;
                    lisaPartnerTransfer = (projected.savings.find(s => s.id === 'lisaPartner') || {}).amount || 0;
                    jointSaverTransfer = (projected.savings.find(s => s.id === 'jointSaver') || {}).amount || 0;
                }
                
                funds.emergency += (unallocatedSurplus + emergencyTransfer);
                funds.immigration += immigrationTransfer;
                funds.lisaSelf += lisaSelfTransfer;
                funds.lisaPartner += lisaPartnerTransfer;
                funds.jointSaver += jointSaverTransfer;

                // Handle special events (Clearance, Immigration Payment)
                if (month === '2026-03') {
                    funds.emergency += state.houseSaleFunds; // <-- ADDED: House sale funds arrive
                    funds.emergency -= state.plan.totalClearanceCost; // <-- Existing: Debts are paid
                }
                if (month === '2027-01') {
                    // 1. Pay for immigration
                    const shortfall = state.plan.immigrationGoal - funds.immigration;
                    if (shortfall > 0) {
                        funds.emergency -= shortfall;
                    }
                    funds.immigration = 0; // Fund is spent
                    
                    // 2. Add this month's surplus to the new joint saver
                    // The LISA transfers are already "spent" in the surplus calculation
                    // This logic is now handled above
                }
                
                const total = funds.emergency + funds.immigration + funds.lisaSelf + funds.lisaPartner + funds.jointSaver;
                
                const diffs = {
                    emergency: funds.emergency - previousFunds.emergency,
                    immigration: funds.immigration - previousFunds.immigration,
                    lisaSelf: funds.lisaSelf - previousFunds.lisaSelf,
                    lisaPartner: funds.lisaPartner - previousFunds.lisaPartner,
                    jointSaver: funds.jointSaver - previousFunds.jointSaver,
                    total: total - previousFunds.total
                };
                
                lastFunds = {...funds, total};

                if (month === currentMonth) {
                    currentFunds = {...lastFunds}; // Capture the state at the end of the current month
                }

                html += `
                    <tr>
                        <td>${getMonthName(month)}</td>
                        <td>${f(funds.emergency)}</td>
                        <td>${f(funds.immigration)}</td>
                        <td>${f(funds.lisaSelf)}</td>
                        <td>${f(funds.lisaPartner)}</td>
                        <td>${f(funds.jointSaver)}</td>
                        <td class="font-bold">${f(total)}</td>
                    </tr>
                `;

                previousFunds = {...lastFunds};
            }
            
            document.getElementById('savings-table-body').innerHTML = html;
            
            // If the plan hasn't started yet (i.e., current real month is before Nov 2025),
            // show the base savings as the current state.
            if (!currentFunds) {
                 if (currentMonth < '2025-12') {
                    currentFunds = { 
                        emergency: state.baseSavings, 
                        immigration: 0, 
                        lisaSelf: 0, 
                        lisaPartner: 0, 
                        jointSaver: 0, 
                        total: state.baseSavings 
                    };
                 } else {
                     // Fallback in case something goes wrong (e.g., currentMonth is past 2030)
                     currentFunds = lastFunds;
                 }
            }
            
            return currentFunds; // Return the current data for the dashboard
        }

        /**
         * Renders the simple debt plan table.
         */
        function renderDebtTable() {
            let html = '';
            DEBT_SCHEDULE.forEach(debt => {
                if (debt.clearance > 0) {
                    html += `
                        <tr>
                            <td>${debt.name}</td>
                            <td>${f(debt.clearance)}</td>
                            <td>${debt.rate}</td>
                            <td class="text-yellow-400">To be Cleared (Mar 2026)</td>
                        </tr>
                    `;
                }
            });
            // Add StepChange
            html += `
                <tr>
                    <td>StepChange DMP</td>
                    <td>(Ongoing)</td>
                    <td>0%</td>
                    <td class="text-green-400">Manageable (Ongoing)</td>
                </tr>
            `;
            document.getElementById('debt-table-body').innerHTML = html;
        }
        
        /**
         * Renders the main dashboard cards and info.
         */
        function renderDashboard() {
            // --- This Month's Snapshot (based on selected month) ---
            const thisMonth = state.currentMonthView; // This is from the dropdown
            const projected = getProjectedBudget(thisMonth);
            const actuals = getActualsForMonth(thisMonth);
            const netResult = actuals.actualSurplus; // This is now the "unallocated" amount
            
            document.getElementById('db-current-month').textContent = getMonthName(thisMonth);
            document.getElementById('db-projected-surplus').textContent = f(projected.projectedSurplus);
            document.getElementById('db-actual-surplus').textContent = f(actuals.totalIncome - actuals.totalOutgoings); // Show actual surplus before unallocated
            document.getElementById('db-net-result').textContent = f(netResult);
            document.getElementById('db-net-result').className = `text-3xl font-bold mt-2 ${netResult < 0 ? 'text-red-400' : 'text-green-400'}`;

            // --- Main Dashboard Cards (with +/- diff) ---
            // These cards will now be based on the *current real-world month*, not the selected dropdown month
            
            // Re-run the savings table render (it populates the table UI)
            renderSavingsTable(); 
            
            // Get the current real-world month
            const currentRealMonth = getCurrentMonthString();
            let selectedMonthForCards = currentRealMonth;
            let prevMonthForCards = null;

            // Find the index of the real month
            const currentRealMonthIndex = MONTHS.indexOf(currentRealMonth);
            
            if (currentRealMonthIndex === -1) {
                // We are before the plan's start month (e.g., it's Nov 2025)
                selectedMonthForCards = null; // Will use base savings
                prevMonthForCards = null;
            } else if (currentRealMonthIndex === 0) {
                 // We are in the first month of the plan
                 prevMonthForCards = null; // Diff will be against base savings
            } else {
                // We are in the plan, get the previous month
                prevMonthForCards = MONTHS[currentRealMonthIndex - 1];
            }
            
            // Get funds for the *real* month and the *real previous* month
            const selectedFunds = getFundBalancesForMonth(selectedMonthForCards);
            const prevFunds = getFundBalancesForMonth(prevMonthForCards);

            // Calculate totals for selected month
            const selectedHomeDeposit = selectedFunds.lisaSelf + selectedFunds.lisaPartner + selectedFunds.jointSaver;
            const selectedTotal = selectedFunds.emergency + selectedFunds.immigration + selectedHomeDeposit;

            // Calculate totals for previous month
            const prevHomeDeposit = prevFunds.lisaSelf + prevFunds.lisaPartner + prevFunds.jointSaver;
            const prevTotal = prevFunds.emergency + prevFunds.immigration + prevHomeDeposit;
            
            // Calculate diffs
            const diffTotal = selectedTotal - prevTotal;
            const diffEmergency = selectedFunds.emergency - prevFunds.emergency;
            const diffImmigration = selectedFunds.immigration - prevFunds.immigration;
            const diffHomeDeposit = selectedHomeDeposit - prevHomeDeposit;
            
            // Update main card figures
            document.getElementById('db-total-savings').textContent = f(selectedTotal);
            document.getElementById('db-emergency-fund').textContent = f(selectedFunds.emergency);
            document.getElementById('db-immigration-fund').textContent = f(selectedFunds.immigration);
            document.getElementById('db-home-deposit').textContent = f(selectedHomeDeposit);
            
            // Update diff elements
            renderDiff(document.getElementById('db-total-savings-diff'), diffTotal);
            renderDiff(document.getElementById('db-emergency-fund-diff'), diffEmergency);
            renderDiff(document.getElementById('db-immigration-fund-diff'), diffImmigration);
            renderDiff(document.getElementById('db-home-deposit-diff'), diffHomeDeposit);
        }
        
        /**
         * Renders all dynamic parts of the UI.
         */
        function renderAll() {
            renderBudgetTable();
            renderDebtTable();
            renderDashboard(); // This also re-renders the savings table
            saveState(); // Save UI state (like current month)
        }

        // --- EVENT HANDLERS ---
        
        /**
         * Handles tab switching.
         */
        function handleTabClick(e) {
            const clickedTab = e.target.closest('.tab-btn');
            if (!clickedTab) return;

            // Update button styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-gray-800', 'text-white');
                btn.classList.add('text-gray-400', 'hover:bg-gray-800', 'hover:text-white');
            });
            clickedTab.classList.add('active', 'bg-gray-800', 'text-white');
            clickedTab.classList.remove('text-gray-400', 'hover:bg-gray-800', 'hover:text-white');

            // Show/hide content
            const tabId = clickedTab.dataset.tab;
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }
        
        /**
         * Handles changes to the "Actual" input fields.
         * This now writes to Firestore.
         */
        async function handleActualChange(event) {
            const { month, id } = event.target.dataset;
            const value = parseFloat(event.target.value) || 0;

            if (!db) {
                console.error("Database not initialized!");
                return;
            }

            // Update the local state immediately for responsiveness
            if (!state.actuals[month]) {
                state.actuals[month] = {};
            }
            state.actuals[month][id] = value;
            renderAll(); // Re-render locally

            // Asynchronously save to Firestore
            try {
                const docRef = doc(db, dbCollectionPath, month);
                // Use setDoc with merge: true to create/update just this one field
                await setDoc(docRef, { [id]: value }, { merge: true });
            } catch (error) {
                console.error("Error writing to Firestore: ", error);
                // Optionally, revert the change or show an error to the user
            }
        }
        
        /**
         * Handles changing the month on the Budget Tracker.
         */
        function handleMonthChange(event) {
            state.currentMonthView = event.target.value;
            renderBudgetTable();
            saveState(); // Save the new UI view
        }

        // --- LOCAL STORAGE (for UI state) ---
        
        function saveState() {
            // Only save non-synced UI state
            const uiState = {
                currentMonthView: state.currentMonthView
            };
            localStorage.setItem('financeTrackerState', JSON.stringify(uiState));
        }

        function loadState() {
            const savedState = localStorage.getItem('financeTrackerState');
            if (savedState) {
                const uiState = JSON.parse(savedState);
                state.currentMonthView = uiState.currentMonthView;
            }
        }

        // --- FIREBASE INITIALIZATION ---

        /**
         * Attaches a real-time listener to the budget collection.
         */
        function attachFirestoreListener() {
            if (!budgetCollectionRef) return;

            onSnapshot(budgetCollectionRef, (snapshot) => {
                console.log("Firestore data updated!");
                snapshot.docChanges().forEach((change) => {
                    const docId = change.doc.id;
                    const docData = change.doc.data();
                    
                    if (change.type === "added" || change.type === "modified") {
                        // Merge the new data into the local state
                        state.actuals[docId] = { ...state.actuals[docId], ...docData };
                    }
                    if (change.type === "removed") {
                        // This shouldn't happen in our app, but good to handle
                        delete state.actuals[docId];
                    }
                });
                
                // Re-render everything with the new data
                renderAll();
            }, (error) => {
                console.error("Error with Firestore snapshot: ", error);
            });
        }

        /**
         * Initializes the app, connects to Firebase, and authenticates.
         */
        async function init() {
            loadState(); // Load UI state (currentMonthView)
            
            // --- PWA Service Worker Registration ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js')
                        .then((registration) => {
                            console.log('Service Worker registered successfully:', registration.scope);
                        })
                        .catch((error) => {
                            console.error('Service Worker registration failed:', error);
                        });
                });
            }
            
            // Set up month selector
            const monthSelector = document.getElementById('month-selector');
            let currentMonth = getCurrentMonthString();
            
            // If it's before the plan starts, set to the start of the plan
            if (currentMonth < '2025-12') {
                currentMonth = '2025-12';
            }
            
            if (!state.currentMonthView) {
                state.currentMonthView = currentMonth;
            }

            MONTHS.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = getMonthName(month);
                if (month === state.currentMonthView) {
                    option.selected = true;
                }
                monthSelector.appendChild(option);
            });
            
            // Add event listeners
            document.querySelector('nav').addEventListener('click', handleTabClick);
            monthSelector.addEventListener('change', handleMonthChange);
            
            // --- Firebase Setup ---
            try {
                // Get config from global variables
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set Firestore log level for debugging
                setLogLevel('Debug');

                // Sign in
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Use the "public" path for collaboration
                        dbCollectionPath = `/artifacts/${appId}/public/data/budget`;
                        budgetCollectionRef = collection(db, dbCollectionPath);
                        
                        console.log("Authenticated. User ID:", userId);
                        console.log("Database path:", dbCollectionPath);

                        // Load data and attach listener
                        attachFirestoreListener();
                        
                        // Initial render (will be updated by listener)
                        renderAll();
                    } else {
                        console.log("User is signed out.");
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // Fallback render without database
                renderAll();
            }
        }

        // Run the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

